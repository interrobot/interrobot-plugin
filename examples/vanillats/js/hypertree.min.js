(()=>{var b=class{static getDocument(t){t=t.replace(b.styleAttributeRegex,"");try{return new DOMParser().parseFromString(t,"text/html")}catch(e){console.warn(e)}}static getDocumentCleanText(t){let e=this.getDocument(t);e===null&&(e=new Document);let s=e.querySelectorAll("script, style, svg, noscript, iframe");for(let i=s.length-1;i>=0;i--)s[i].parentElement.removeChild(s[i]);return e}static getDocumentCleanTextIterator(t){let e=b.getDocumentCleanText(t),s="//text() | //meta[@name='description']/@content | //@alt";return e.evaluate(s,e,null,XPathResult.ANY_TYPE,null)}static getElementTextIterator(t,e){let s=".//text()";return t.evaluate(s,e,null,XPathResult.ANY_TYPE,null)}static getElementTextOnly(t,e){let s=b.getElementTextIterator(t,e),i=[],a=s.iterateNext();for(;a;)i.push(a.nodeValue.trim()),a=s.iterateNext();return i.join(" ")}static isUrl(t){return URL.canParse(t)}static htmlEncode(t){return new Option(t).innerHTML}};b.urlsRegex=/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_\:]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)/g;b.urlRegex=/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_\:]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w]*))?)$/;b.styleAttributeRegex=/style\s*=\s*("([^"]*)"|'([^']*)')/gi;var $;(function(f){f[f.Page=0]="Page",f[f.Asset=1]="Asset",f[f.Any=2]="Any"})($||($={}));var H;(function(f){f[f.Id=0]="Id",f[f.Time=1]="Time",f[f.Status=2]="Status",f[f.Url=3]="Url"})(H||(H={}));var z;(function(f){f[f.Ascending=0]="Ascending",f[f.Descending=1]="Descending"})(z||(z={}));var N=class{constructor(t){var e;if(this.meta=t.meta,this.defaultData=t.defaultData,this.autoformInputs=(e=t.autoformInputs)!==null&&e!==void 0?e:[],this.project=t.projectId,this.data={apiVersion:"1.1",autoform:{}},this.data.autoform===null&&(this.data.autoform=[]),this.data.autoform[this.project]={},this.autoformInputs.length>0){let s=async n=>{let r=n.getAttribute("name"),u;n instanceof HTMLSelectElement||n instanceof HTMLTextAreaElement||n.hasAttribute("value")?u=n.value:u=!(n.checked===void 0||n.checked===!1),await this.setAutoformField(r,u)},i=async n=>{let r=n.getAttribute("name"),u=n,d=document.querySelectorAll(`input[type=radio][name=${u.name}]:checked`);if(d.length!==1){console.error("radio control failure");return}let l=d[0].value;await this.setAutoformField(r,l)},a=async n=>{let r=n.getAttribute("name"),u=n,d=document.querySelectorAll(`input[type=checkbox][name=${u.name}]:checked`),l=[];for(let c=0;c<d.length;c++)l.push(d[c].value);let o=l.join("|");await this.setAutoformField(r,o)};for(let n of this.autoformInputs){if(n===null)continue;switch(n.tagName.toLowerCase()){case"input":let u=n;if(u.type=="checkbox"){let o=n,c=document.querySelectorAll(`input[type=checkbox][name=${o.name}]`);c.length===1?u.addEventListener("change",async h=>{await s(u)}):c.length>1&&u.addEventListener("change",async h=>{await a(u)})}else u.type=="radio"?u.addEventListener("change",async o=>{await i(u)}):u.addEventListener("change",async o=>{await s(u)});break;case"textarea":let d=n;d.addEventListener("change",async o=>{await s(d)}),d.addEventListener("input",async o=>{await s(d)});break;case"select":let l=n;l.addEventListener("change",async o=>{await s(l)});break;default:break}}}}async setDataField(t,e,s){this.data[t]!==e&&(this.data[t]=e),s===!0&&await this.updateData()}async getData(){return this.dataLoaded!==null?this.data:(await this.loadData(),this.data)}async loadData(){var t,e,s;let i=window.location.href;i==="about:srcdoc"&&(i=`/reports/${window.parent.document.getElementById("report").dataset.report}/`);let a={pluginUrl:i},n=new Date().getTime(),r=await p.postApiRequest("GetPluginData",a),u=new Date().getTime();try{p.logTiming(`Loaded options: ${JSON.stringify(a)}`,u-n);let l=r.data,o=Object.keys(l).length===0,c={};for(let h in this.defaultData){let g=this.defaultData[h];c[h]=this.defaultData[h]}for(let h in l){let g=this.defaultData[h];c[h]=l[h]}o&&(this.data=c,await this.updateData()),this.data=c,this.dataLoaded=new Date}catch{console.warn(`failed to load plugin data @ 
${JSON.stringify(a)}`)}if(this.autoformInputs.length>0){if(!("autoform"in this.data))this.data.autoform={};else for(let l in this.data.autoform)isNaN(parseInt(l,10))&&delete this.data.autoform[l];if(!(this.project in this.data.autoform)){let l=(e=(t=this.defaultData.autoform)===null||t===void 0?void 0:t[this.project])!==null&&e!==void 0?e:{};this.data.autoform[this.project]=l}}let d=[];for(let l of this.autoformInputs){if(l===null)continue;let o=l.name,c=(s=this.data.autoform[this.project][o])!==null&&s!==void 0?s:null,h=l.tagName.toLowerCase(),g,x=!1,v=!1,y=!1,w=!1,C=!1;switch(h){case"input":g=l,g.type==="radio"?(y=!0,d.push(o)):g.type==="checkbox"&&typeof c=="boolean"?x=!0:g.type==="checkbox"&&typeof c=="string"&&(v=!0);break;case"textarea":g=l,C=!0;break;case"select":g=l,w=!0;break;default:break}if(!g){console.warn("autoform: no input found");return}switch(!0){case y:g.checked=c===g.value;break;case x:g.checked=c||!1;break;case v:g.checked=c?c.toString().indexOf(g.value)>=0:!1;break;case C:g.value=c||"";break;case w:default:c&&(g.value=c);break}}d.forEach(l=>{if(!(document.querySelector(`input[name=${l}]:checked`)!==null)){let c=document.querySelector(`input[name=${l}]`);c&&(c.checked=!0)}})}async setAutoformField(t,e){var s,i;let n=(s=(await this.getData()).autoform)!==null&&s!==void 0?s:{},r=(i=n[this.project])!==null&&i!==void 0?i:{};r[t]!==e&&(r[t]=e,await this.setDataField("autoform",n,!0))}async updateData(){let t=await this.getData();t.meta=this.meta;let e={pluginUrl:window.location.href,pluginData:t},s=await p.postApiRequest("SetPluginData",e)}getDataSlug(){let t=this.getPluginUrl();return btoa(t)}getPluginUrl(){return`${window.location.protocol}//${window.location.host}${window.location.pathname}`}},R=class{constructor(t){var e,s,i;this.includeExternal=!0,this.includeNoRobots=!1,this.project=t.project,this.query=t.query,this.fields=t.fields,this.type=t.type,this.includeExternal=(e=t.includeExternal)!==null&&e!==void 0?e:!0,this.includeNoRobots=(s=t.includeNoRobots)!==null&&s!==void 0?s:!1,this.perPage=(i=t.perPage)!==null&&i!==void 0?i:R.maxPerPage,R.validSorts.indexOf(t.sort)>=0?this.sort=t.sort:this.sort=R.validSorts[1]}getHaystackCacheKey(){return`${this.project}~${this.fields}~${this.type}~${this.includeExternal}~${this.includeNoRobots}`}};R.maxPerPage=100;R.validSorts=["?","id","-id","time","-time","status","-status","url","-url"];var k=class{static async execute(t,e,s,i=!1,a=!0,n="Processing..."){let r=new Date().getTime();if(t.getHaystackCacheKey()===k.resultsHaystackCacheKey&&e){let c=e.size;if(a===!1){let g=new CustomEvent("ProcessingMessage",{detail:{action:"set",message:n}});document.dispatchEvent(g)}await k.sleep(16);let h=0;if(await e.forEach(async(g,x)=>{await s(g)}),p.logTiming(`Processed ${c.toLocaleString()} search result(s)`,new Date().getTime()-r),a===!1){let g={detail:{action:"clear"}},x=new CustomEvent("ProcessingMessage",g);document.dispatchEvent(x)}return!0}else k.resultsHaystackCacheKey=t.getHaystackCacheKey(),k.resultsCacheTotal=0;let u={project:t.project,query:t.query,external:t.includeExternal,type:$[t.type].toLowerCase(),offset:0,fields:t.fields.split("|"),norobots:t.includeNoRobots,sort:t.sort,perpage:t.perPage},d=await p.postApiRequest("GetResources",u),l=d.__meta__.results.total;k.resultsCacheTotal=l;let o=d.results;for(let c=0;c<o.length;c++){let h=o[c];await k.handleResult(h,l,s)}for(;d.__meta__.results.pagination.nextOffset!==null&&i===!0;){let c=d.__meta__.results.pagination.nextOffset;u.offset=c,d=await p.postApiRequest("GetResources",u),o=d.results;for(let h=0;h<o.length;h++){let g=o[h];await k.handleResult(g,l,s)}}return p.logTiming(`Loaded/processed ${l.toLocaleString()} search result(s)`,new Date().getTime()-r),!1}static async sleep(t){return new Promise(e=>setTimeout(()=>e(),t))}static async handleResult(t,e,s){let i=new S(t);await s(i);let a=i.result,n=new CustomEvent("SearchResultHandled",{detail:{resultNum:a,resultTotal:e}});document.dispatchEvent(n)}},S=class{static normalizeContentWords(t){let e=[];return t!==""&&e.push.apply(e,t.split(/\s+/)),e}static normalizeContentString(t){return S.normalizeContentWords(t).join(" ")}constructor(t){var e;this.optionalFields=["created","modified","size","status","time","norobots","name","type","content","headers","links","assets","origin"],this.result=t.result,this.id=t.id,this.url=(e=t.url)!==null&&e!==void 0?e:null,this.name=t.name,this.processedContent="";for(let s of this.optionalFields)s in t&&(s==="created"||s==="modified"?this[s]=new Date(t[s]):this[s]=t[s])}hasProcessedContent(){return this.processedContent!=""}getProcessedContent(){return this.processedContent}setProcessedContent(t){this.processedContent=t}getContent(){return this.content}getContentTextOnly(){let t=[],e=null,s=b.getDocumentCleanTextIterator(this.getContent());for(e=s.iterateNext();e!==null;){let a=S.normalizeContentString(e.nodeValue);if(a!==""){let n=a.split(" ").filter(r=>r!=="");n.length>0&&t.push.apply(t,n)}e=s.iterateNext()}let i=t.join(" ");return i=i.replace(S.wordPunctuationRe,""),i=i.replace(S.wordWhitespaceRe," "),i}getHeaders(){return this.headers}getUrlPath(){return new URL(this.url).pathname}clearFulltextFields(){this.content="",this.headers=""}};S.wordPunctuationRe=/\s+(?=[\.,;:!\?] )/g;S.wordWhitespaceRe=/\s+/g;var O=class{constructor(t){this.id=-1,this.created=null,this.modified=null,this.project=-1,this.time=-1,this.report=null,this.id=t.id,this.project=t.project,this.created=t.created,this.modified=t.modified,this.complete=t.complete,this.time=t.time,this.report=t.report}getTimings(){return this.getReportDetailByKey("timings")}getSizes(){return this.getReportDetailByKey("sizes")}getCounts(){return this.getReportDetailByKey("counts")}getReportDetailByKey(t){return this.report&&this.report.hasOwnProperty("detail")&&this.report.detail.hasOwnProperty(t)?this.report.detail[t]:null}},A=class{constructor(t){this.id=-1,this.created=null,this.modified=null,this.name=null,this.url=null,this.urls=[],this.imageDataUri=null,this.id=t.id,this.created=t.created,this.modified=t.modified,this.url=t.url,this.name=t.name,this.imageDataUri=t.imageDataUri}getImageDataUri(){return this.imageDataUri}getDisplayTitle(){return this.name?this.name:this.url?(p.logWarning(A.urlDeprectionWarning),new URL(this.url).hostname):"[error]"}getDisplayUrl(){if(this.urls){let t=this.urls[0],e=this.urls.length,s=e>1?` + ${e-1} more`:"";return`${t}${s}`}else return this.url?(p.logWarning(A.urlDeprectionWarning),new URL(this.url).hostname):"[error]"}static async getApiProject(t){let e={projects:[t],fields:["image","created","modified"]},i=(await p.postApiRequest("GetProjects",e)).results;for(let a=0;a<i.length;a++){let n=i[a];if(n.id===t){let r=new Date(n.created),u=new Date(n.modified),d=n.name||n.url,l=n.image;return new A({id:t,created:r,modified:u,name:d,imageDataUri:l})}}return null}static async getApiCrawls(t){let e={complete:"complete",project:t,fields:["created","modified","report","time"]},s=await p.postApiRequest("GetCrawls",e),i=[],a=s.results;for(let n=0;n<a.length;n++){let r=a[n];i.push(new O({id:r.id,project:t,created:new Date(r.created),modified:new Date(r.modified),complete:r.complete,time:r.time,report:r.report}))}return i}};A.urlDeprectionWarning='"url" field is deprecated, use "name" or "urls" instead.';var U=class{constructor(){let t=document.body;t.addEventListener("touchstart",e=>{this.proxyToContainer(e)},{passive:!0}),t.addEventListener("touchend",e=>{this.proxyToContainer(e)},{passive:!0}),t.addEventListener("touchmove",e=>{this.proxyToContainer(e)},{passive:!0})}async proxyToContainer(t){var e;let s,i=(e=t.touches)!==null&&e!==void 0?e:t.changedTouches;if(t.touches.length===1)s=t.touches[0];else if(t.changedTouches.length===1)s=t.changedTouches[0];else return;let n={target:"interrobot",data:{reportTouch:{identifier:null,target:null,clientX:s.clientX,clientY:s.clientY,pageX:s.pageX,pageY:s.pageY,screenX:s.screenX,screenY:s.screenY,radiusX:s.radiusX,radiusY:s.radiusY,rotationAngle:s.rotationAngle,force:s.force,eventType:t.type}}};window.parent.postMessage(n,"*")}async touchEnd(t){}async touchMove(t){}};var j;(function(f){f[f.Light=0]="Light",f[f.Dark=1]="Dark"})(j||(j={}));var B=class{constructor(t,e){this.iframeSrc=t,e?this.hostOrigin=e:this.hostOrigin="";let s=new URL(t);t==="about:srcdoc"?this.pluginOrigin="about:srcdoc":this.pluginOrigin=s.origin}getIframeSrc(){return this.iframeSrc}getHostOrigin(){return this.hostOrigin}getPluginOrigin(){return this.pluginOrigin}toString(){return`host = ${this.hostOrigin}; plugin = ${this.pluginOrigin}`}},p=class{static async initialize(t){let e=()=>{let s=new t;return p.postMeta(s.constructor.meta),window.addEventListener("load",()=>p.postContentHeight()),window.addEventListener("resize",()=>p.postContentHeight()),s};return document.readyState==="complete"||document.readyState==="interactive"?e():new Promise(s=>{document.addEventListener("DOMContentLoaded",()=>{s(e())})})}static postContentHeight(t=null){let e=document.querySelector(".main__results"),s=document.body.scrollHeight;if(e&&(s=Number(e.getBoundingClientRect().bottom)),s!==p.contentScrollHeight){let a={target:"interrobot",data:{reportHeight:t&&t>=1?Math.min(t,s):s}};p.routeMessage(a)}}static postOpenResourceLink(t,e){let s={target:"interrobot",data:{reportLink:{openInBrowser:e,resource:t}}};p.routeMessage(s)}static postMeta(t){let e={target:"interrobot",data:{reportMeta:t}};p.routeMessage(e)}static async postApiRequest(t,e){let s=null;return await(async()=>new Promise(a=>{let n=async u=>{var d;if(u===void 0)return;let l=u.data,o=(d=l.data)!==null&&d!==void 0?d:{};if(o&&typeof o=="object"&&o.hasOwnProperty("apiResponse")){let c=o.apiResponse.__meta__.request.method;t===c&&(s=l.data.apiResponse,window.removeEventListener("message",n),a())}},r={target:"interrobot",data:{apiRequest:{method:t,kwargs:e}}};window.addEventListener("message",n),p.routeMessage(r)}))(),s}static logTiming(t,e){let s=(e/1e3).toFixed(3);console.log(`\u{1F916} [${s}s] ${t}`)}static logWarning(t){console.warn(`\u{1F916} ${t}`)}static routeMessage(t){let e="";p.connection?(e=p.connection.getHostOrigin(),window.parent.postMessage(t,e)):window.parent.postMessage(t)}static GetStaticBasePath(){function t(){if("userAgentData"in navigator&&navigator.userAgentData)return navigator.userAgentData.platform.toLowerCase()==="linux";{let e=navigator.userAgent.toLowerCase();return e.includes("android")||e.includes("cros")?!1:e.includes("linux")}}return t()?"":"/_content/Interrobot.Common"}constructor(){this.projectId=-1,this.mode=j.Light;let t,e,s;if(this.parentIsOrigin()){let n=window.parent.document.getElementById("report");t=parseInt(n.dataset.project,10),e=parseInt(n.dataset.mode,10),s=n.dataset.origin}else{let n=new URLSearchParams(window.location.search);t=parseInt(n.get("project"),10),e=parseInt(n.get("mode"),10),s=n.get("origin")}if(p.connection=new B(document.location.href,s),isNaN(t)){let n="missing project url argument";throw new Error(n)}this.data=null,this.projectId=t,this.mode=isNaN(e)||e!==1?j.Light:j.Dark,p.contentScrollHeight=0;let i=j[this.mode].toLowerCase();document.body.classList.remove("light","dark"),document.body.classList.add(i);let a=new U}delay(t){return new Promise(e=>setTimeout(e,t))}getMode(){return this.mode}getProjectId(){return this.projectId}getInstanceMeta(){return this.constructor.meta}async initData(t,e){this.data=new N({projectId:this.getProjectId(),meta:this.getInstanceMeta(),defaultData:t,autoformInputs:e}),await this.data.loadData()}async initAndGetData(t,e){return await this.initData(t,e),this.data}async getProject(){if(this.project===void 0){let t=await A.getApiProject(this.projectId);if(t===null){let e=`project id=${this.projectId} not found`;throw new Error(e)}this.project=t}return this.project}render(t){document.body.innerHTML=t}async index(){let t=await A.getApiProject(this.getProjectId()),e=b.htmlEncode(t.getDisplayTitle()),s=b.htmlEncode(p.meta.title);this.render(`
            <div class="main__heading">
                <div class="main__heading__icon">
                    <img id="projectIcon" src="${t.getImageDataUri()}" alt="Icon for ${e}" />
                </div>
                <div class="main__heading__title">
                    <h1>${s}</h1>
                    <div><span>${e}</span></div>
                </div>
            </div>
            <div class="main__form">
                <p>Welcome, from the index() of the Plugin base-class. This page exists as a placeholder, 
                but in your hands it could be so much more. The Example Report form below will count and 
                present page title terms used across the website, by count.
                It's an example to help get you started.</p>
                <p>If you have any questions, please reach out to the dev via the in-app contact form.</p>
                <form><button>Example Report</button></form>
            </div>
            <div class="main__results"></div>`),document.getElementsByTagName("button")[0].addEventListener("click",async a=>{await this.process()})}async process(){let t=new Map,e,s=async(u,d)=>{let l=u.name.trim().split(/[\s\-â€”]+/g);for(let o of l)if(!d.has(o))d.set(o,1);else{let c=d.get(o);d.set(o,c+1)}},i=this.getProjectId(),a="headers: text/html",n="name",r=new R({project:i,query:a,fields:n,type:$.Any,includeExternal:!1,includeNoRobots:!1});await k.execute(r,e,async u=>{await s(u,t)},!0,!1,"Processing\u2026"),await this.report(t)}async report(t){let e=new Map([...t.entries()].sort((a,n)=>{let r=a[1],u=n[1];return r===u?a[0].toLowerCase().localeCompare(n[0].toLowerCase()):u-r})),s=[];for(let a of e.keys()){let n=e.get(a),r=a.length>24?a.substring(24)+"\u2026":a;s.push(`<tr><td>${b.htmlEncode(r)}</td><td>${n.toLocaleString()}</td></tr>`)}let i=document.querySelector(".main__results");i.innerHTML=s.length===0?"<p>No results found.</p>":`<div><section><table style="max-width:340px">
            <thead><tr><th>Term</th><th>Count</th></tr></thead>
            <tbody>${s.join("")}</tbody>
            </table></section></div>`,p.postContentHeight()}parentIsOrigin(){try{if(!window.parent||window.parent===window)return!1;let t=window.parent.document;return t?!t.hidden:!1}catch{return!1}}};p.meta={title:"InterroBot Base Plugin",category:"Example",version:"1.0",author:"InterroBot",description:`Welcome to InterroBot plugin development. This base-class Plugin can already 
        query the database, draw conclusions, and report back. It's just few tweaks away from being 
        your own creation.

This is the default plugin description. Set meta: {} values
        in the source to update these display values.`};var E=class{static setMode(t){E.mode=t}static status2Class(t){return t<0?"disabled":t>0&&t<400?"ok":t>=400&&t<500?"warn":"error"}static status2Color(t){let e=E.status2Class(t),s={};return E.mode===j.Dark?s={disabled:"#666666",ok:"#00a0df",warn:"#babe42",error:"#d5350a"}:s={disabled:"#666666",ok:"#0592b2",warn:"#bf8600",error:"#d53a0a"},s[e]}static type2Char(t){return t in E.charItMap?E.charItMap[t]:E.charItMap.html}};E.mode=j.Dark;E.charItMap={img:"i",css:"c",script:"s",html:"h",style:"c",video:"v",audio:"a",rss:"y",iframe:"f",blob:"b"};var D=class extends p{static escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}getNonResultUniqueId(){return--this.nonResultId}constructor(){super(),this.nonResultId=0,this.resultsMap=new Map,this.resultUrlMap=new Map,this.renderedIds=[],this.currentDetailId=-1,this.currentSearchIndex=-1,this.isNavigating=!1,this.searchNavigationQueue=Promise.resolve(),this.index()}async index(){E.setMode(this.getMode()),hyt.status2Class=E.status2Class,hyt.status2Color=E.status2Color,hyt.type2Char=E.type2Char;let t={},e=await A.getApiProject(this.getProjectId()),s=new R({project:this.getProjectId(),query:"norobots: false AND redirect: false",fields:"name|status|type",type:$.Any,includeExternal:!1,includeNoRobots:!0});this.component=new hyt.Hypertree({parent:document.body},{dataloader:this.fromApi(s),langloader:this.fromUndefinedLangauge(),langInitBFS:(i,a)=>{let n=a.data.name;a.precalc.label=n,a.precalc.icon=""},filter:{maxlabels:12},geometry:{captionFont:"12px Montserrat",captionHeight:.09}}),await this.component.initPromise.then(()=>new Promise((i,a)=>this.component.animateUp(i,a))).then(()=>this.component.drawDetailFrame()),this.searchDialog=await this.generateSearchDialog(),document.addEventListener("hypertreeDetail",async i=>{await this.openDetail(i)}),document.addEventListener("hypertreeUpdated",async i=>{let a=document.querySelector("input:focus");a&&a.name==="query"?(console.log("close query"),this.searchDialog.close(),window.requestAnimationFrame(()=>{a.blur()})):document.querySelector("button:focus")!==null&&await this.closeDetail(!1)}),document.addEventListener("hypertreePanic",async i=>{await this.openDialog(this.panicDialog)}),this.resultDialog=this.generateResultDialog(),this.panicDialog=this.generatePanicDialog(),window.addEventListener("resize",i=>{document.querySelectorAll("dialog hr").forEach(n=>{var r;(r=n.parentNode)===null||r===void 0||r.removeChild(n)}),p.postContentHeight(window.innerWidth)}),document.addEventListener("keydown",async i=>{switch(i.key){case"`":i.preventDefault(),await this.openDialog(this.searchDialog);break;case"ArrowLeft":case"ArrowRight":if(this.resultDialog.hasAttribute("open")){let a=this.resultDialog.querySelector("button:focus");if(a){let n=a.nextElementSibling,r=a.previousElementSibling;(n==null?void 0:n.tagName)==="BUTTON"?n.focus():(r==null?void 0:r.tagName)==="BUTTON"&&r.focus()}}break;case"ArrowUp":this.searchDialog.hasAttribute("open")&&this.focusPreviousSearchDialogResult();break;case"ArrowDown":this.searchDialog.hasAttribute("open")&&this.focusNextSearchDialogResult();break;case"Escape":this.resultDialog.hasAttribute("open")&&await this.closeDetail(!0),this.searchDialog.hasAttribute("open")&&(await this.closeDialog(this.searchDialog),this.searchDialog.querySelector("input[type=text]").blur());break;default:break}}),p.postContentHeight(window.innerWidth)}clearMaps(){this.resultsMap.clear(),this.resultUrlMap.clear(),this.renderedIds=[]}findNodeById(t,e){if(!t)return null;if(t.data&&t.data.interrobotId===e)return t;if(t.children&&Array.isArray(t.children))for(let s of t.children){let i=this.findNodeById(s,e);if(i)return i}return null}generateResultDialog(){let t=document.createElement("dialog");return t.setAttribute("id",D.resultDialogId),document.body.appendChild(t),t}async handleSearchResultClick(t,e){var s;(s=this.searchDialog.querySelector("input"))===null||s===void 0||s.blur(),this.searchDialog.close(),this.searchNavigationQueue=this.searchNavigationQueue.then(async()=>{this.isNavigating=!0;try{this.isNavigating=!0,t.preventDefault(),await this.component.initPromise.then(()=>this.component.drawDetailFrame()).then(()=>this.component.unitdisk.update.transformation()).then(()=>new Promise((n,r)=>{let u=0,d=120,l=()=>{var o;u++;let c=this.findNodeById(this.component.data,e);if((c==null?void 0:c.layout)===null&&this.component.updateLayoutPath_(c),!((o=c==null?void 0:c.layout)===null||o===void 0)&&o.z)n(c);else{if(u>d)return this.component.transition=null,this.component.unitdisk.update.transformation(),r(new Error("failed checkNode after maximum attempts"));requestAnimationFrame(l)}};l()})).then(n=>new Promise((r,u)=>{(n==null?void 0:n.layout)===null&&this.component.updateLayoutPath_(n),this.component.api.gotoNode(n);let d=0,l=120,o=()=>{if(d++,d>l)return this.component.transition=null,this.component.unitdisk.update.transformation(),u(new Error("failed checkAnimation after maximum attempts"));this.component.transition?requestAnimationFrame(o):r(n)};o()})).then(()=>this.component.api.goto\u03BB(.25)).catch(n=>{console.error("navigation failed or interrupted:",n)}),this.isNavigating=!1,this.component.update.data();let i=this.findNodeById(this.component.data,e);(i==null?void 0:i.layout)===null&&this.component.updateLayoutPath_(i);let a=new CustomEvent("hypertreeDetail",{detail:{id:i.data.interrobotId,timestamp:Date.now()}});document.dispatchEvent(a)}finally{this.isNavigating=!1}})}async generateSearchDialog(){let t=document.createElement("dialog");t.setAttribute("id",D.searchDialogId),document.body.appendChild(t),t.innerHTML=`
        <div class="message fadeIn">
            <form id="HypertreeForm">
                <div class="message__search">
                    <input type="text" name="query" value="" placeholder="Search by title and/or URL"
                        spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"/>
                    <button><span class="icon">%</span></button>
                    <input type="hidden" name="nodes" value=""/>
                </div>
                <div class="message__results__meta">
                    <!-- e.g. Found 120. Showing 1-5 and errors -->
                </div>
                <div id="${D.searchResultsDialogId}" class="message__results"></div>
            </form>
        <div>`;let e=t.querySelector("button"),s=t.querySelector("input[name=query]"),i=t.querySelector("input[name=nodes]"),a={},n=[s,i];await this.initData(a,n),i.value.split(",").map(Number).forEach(d=>{let l=this.findNodeById(this.component.data,d);l&&!this.component.args.objects.selections.includes(l)&&this.component.api.toggleSelection(l)}),e==null||e.addEventListener("click",d=>{d.preventDefault(),this.closeDialog(this.searchDialog)}),s==null||s.addEventListener("focus",async d=>{await this.openDialog(this.searchDialog)}),s==null||s.addEventListener("click",async d=>{await this.openDialog(this.searchDialog)}),s==null||s.addEventListener("keyup",async d=>{await this.openDialog(this.searchDialog)});let u=t.querySelector("input[name=query]");return u!==null&&u.addEventListener("keyup",async d=>{d.preventDefault();let l=u.value.toLocaleLowerCase(),o=[],c=new RegExp(`^${D.escapeRegExp(l)}`,"i"),h=new RegExp(`\b${D.escapeRegExp(l)}`,"i"),g=new RegExp(`${D.escapeRegExp(l)}`,"i");for(let[I,m]of this.resultsMap)m.sort=-1,m.status.toString()===l?m.sort=70:c.test(m.name)?m.sort=60:h.test(m.name)?m.sort=50:g.test(m.name)?m.sort=40:c.test(m.url)?m.sort=30:g.test(m.url)&&(m.sort=20),m.sort>=20&&this.renderedIds.indexOf(m.id)>=0&&o.push(m);o.sort((I,m)=>{var L,M;let P=((L=m.sort)!==null&&L!==void 0?L:0)-((M=I.sort)!==null&&M!==void 0?M:0);if(P!==0)return P;let q=I.type.localeCompare(m.type);return q!==0?q:I.name.localeCompare(m.name)});let x=o.length,v=l.trim()==="";o=o.slice(0,5);let y=t.querySelector(".message__results__meta");y&&!v?y.innerHTML=`Found <strong>${x.toLocaleString()}</strong> results.
                        ${x===0?"":"Showing  1\u2013"+o.length}`:y&&(y.innerHTML="");let w=document.getElementById(D.searchResultsDialogId);if(w.innerHTML="",l.trim()==="")return;let C=new RegExp(`${D.escapeRegExp(l)}`,"gi"),_=I=>I.replace(C,"<mark>$&</mark>"),T=document.createDocumentFragment();for(let I=0;I<o.length;I++){let m=document.createElement("a"),L=o[I],M=L.id,P=new URL(L.url).pathname;m.classList.add("result"),m.href="#",m.innerHTML=`<div class="result__name">${_(L.name)}</div>
                        <div class="result__url">${_(P)}</div>`,m.addEventListener("click",async q=>{this.handleSearchResultClick(q,M)}),T.appendChild(m)}w==null||w.append(T)}),t}generatePanicDialog(){var t;let e=document.createElement("dialog");return e.setAttribute("id",D.panicDialogId),document.body.appendChild(e),e.innerHTML=`
        <div class="message">
            <h2 class="message__title">Out of bounds. Unrecoverable.</h2>
            <div class="message__link">You've flown too close to the sun. The edges of the map
                can be tricky, avoid zooming into voids.</div>
            <div class="message__buttons"><button>Reload</button></div>
        <div>`,(t=e.querySelector("button"))===null||t===void 0||t.addEventListener("click",async s=>{this.panicDialog.close(),await this.component.initPromise.then(()=>new Promise((i,a)=>this.component.animateUp(i,a))).then(()=>this.component.drawDetailFrame()).then(()=>this.component.unitdisk.update.transformation()).then(()=>this.component.api.goto\u03BB(.25))}),e}getDialogs(){return[this.panicDialog,this.resultDialog,this.searchDialog]}async openDialog(t){this.resultDialog.classList.remove("fadeOut");let e=this.getDialogs().filter(s=>s!==t&&s.hasAttribute("open")).map(async s=>{s.id===D.resultDialogId?await this.closeDetail(!0):s.close()});if(await Promise.all(e),!t.hasAttribute("open")&&(t.show(),t.id===D.searchDialogId)){this.currentSearchIndex=-1;let s=t.querySelector("input[name=query]");s==null||s.dispatchEvent(new Event("keyup",{bubbles:!1}))}}closeDialog(t){this.getDialogs().forEach(e=>{e.hasAttribute("open")&&e.close()})}focusSearchDialogResult(t){let e=this.searchDialog.querySelectorAll(".result"),s=this.searchDialog.querySelector("input[name=query]");if(!this.searchDialog.hasAttribute("open"))this.currentSearchIndex=-1,s.focus(),window.requestAnimationFrame(()=>{s.select()});else if(e.length===0)return;if(this.currentSearchIndex+=t,this.currentSearchIndex===-2&&(this.currentSearchIndex=e.length-1),this.currentSearchIndex>=e.length||this.currentSearchIndex<0){this.currentSearchIndex=-1,s.focus(),window.requestAnimationFrame(()=>{s.select()});return}e[this.currentSearchIndex].focus()}focusPreviousSearchDialogResult(){this.focusSearchDialogResult(-1)}focusNextSearchDialogResult(){this.focusSearchDialogResult(1)}async updateAutoformNodes(){let t=[],e=[...this.component.args.objects.selections];e.sort((i,a)=>i.data.interrobotStatus-a.data.interrobotStatus),e.forEach(i=>{let a=i.data.interrobotId;a>=0&&t.push(a)});let s=t.join(",");await this.data.setAutoformField("nodes",s)}async openDetail(t){var e;let s=(e=this.resultsMap.get(t.detail.id))!==null&&e!==void 0?e:null;if(s===null)return;let i=this.resultDialog.querySelector(".message");if(i==null||i.classList.remove("fadeIn","fadeOut"),this.resultDialog.querySelectorAll("hr.line").forEach(r=>{r==null||r.classList.remove("fadeIn","fadeOut")}),this.resultDialog.hasAttribute("open")&&s&&s.id===this.currentDetailId){await this.closeDetail(!1),console.log(s);return}let n=`
        <div class="message fadeIn">
            <h2 class="message__title"><span class="status">${s.status}</span>
                <span class="type">${E.type2Char(s.type)}</span>
                ${b.htmlEncode(s.name)}</h2>
            <div class="message__link">
                <a data-id="${s.id}" href="${b.htmlEncode(s.url)}">
                    ${b.htmlEncode(s.url)}</a>
            </div>
            <div class="message__buttons">
                <button>Cancel</button>
                <button>Add Path</button>
            </div>
        </div>`;if(s&&n){let r=[];this.component.args.objects.selections.forEach(v=>{r.push(v.data.interrobotId)}),r.indexOf(s.id)>=0,this.resultDialog.innerHTML=n;let d=this.findNodeById(this.component.data,s.id);this.component.args.objects.selections.includes(d)||this.component.api.toggleSelection(d);let l=this.resultDialog.querySelectorAll("button"),o=l[0];o&&o.addEventListener("click",async v=>{v.preventDefault(),await this.closeDetail(!0)});let c=l[1];c&&(c.addEventListener("click",async v=>{v.preventDefault(),await this.closeDetail(!1)}),window.setTimeout(()=>c.focus(),10));let h=this.resultDialog.querySelector("a");h==null||h.addEventListener("click",v=>{var y,w;v.preventDefault();let C=(w=parseInt((y=h.dataset.id)!==null&&y!==void 0?y:"0",10))!==null&&w!==void 0?w:0;p.postOpenResourceLink(C,!0)}),await this.openDialog(this.resultDialog),this.resultDialog.classList.remove("ok","error","warn","disabled"),this.resultDialog.classList.add(E.status2Class(s.status)),this.currentDetailId=s.id;let g=document.getElementById(`result${s.id}`),x=this.resultDialog.getBoundingClientRect();if(g!==null){let v=g.getBoundingClientRect(),y=v.left+v.width/2,w=v.top+v.height/2,C=(T,I,m,L)=>Math.sqrt(Math.pow(T-m,2)+Math.pow(I-L,2)),_=["lt","rt","lb","rb"];v.left===0&&v.top===0||_.forEach(T=>{let I=document.createElement("hr");I.setAttribute("class",`line ${T}`),this.resultDialog.append(I);let m=T[0]==="l"?x.x:x.x+x.width,L=T[1]==="t"?x.y:x.y+x.height,M=C(m,L,y,w),P=0;T[0]==="l"?P=Math.atan2(w-L,y-m)*(180/Math.PI):P=Math.atan2(L-w,m-y)*(180/Math.PI),I.style.width=`${M}px`,I.style.transform=`rotate(${P}deg)`})}}else await this.closeDetail(!1)}async closeDetail(t){if(this.isNavigating)return;if(t===!0){let a=this.component.args.objects.selections,n=a.length>0?a[a.length-1]:null;n&&this.component.api.toggleSelection(n)}await this.updateAutoformNodes();let e=this.resultDialog.querySelector(".message");e==null||e.classList.remove("fadeIn"),e==null||e.classList.add("fadeOut"),this.resultDialog.querySelectorAll("hr.line").forEach(a=>{a.classList.add("fadeOut")}),this.currentDetailId=-1,this.closeDialog(this.resultDialog);let i=this.searchDialog.querySelector("input[name=query]");i==null||i.blur()}fromUndefinedLangauge(){return t=>{let e=performance.now();t({},e,0)}}truncateTitle(t){if(t.length<=36)return t;let s=t.split(" "),i=s[0];for(let a=1;a<s.length;a++){let n=i+" "+s[a];if(n.length<=36)i=n;else break}return i+"\u2026"}getResultStem(t,e,s,i,a,n){return{name:`${this.truncateTitle(e||s)}`,numLeafs:n.length,interrobotId:t,interrobotType:a,interrobotStatus:i,children:n}}gatherResultsBranches(t,e,s){var i;let a=[],n=Object.keys(t);for(let r=0;r<n.length;r++){let u=n[r];if(u==="__meta__")continue;let d=t[u],l=(i=d==null?void 0:d.__meta__)===null||i===void 0?void 0:i.url,o=this.resultUrlMap.get(this.normalizeUrl(l)),c=o!==void 0;if(o!==void 0){let h=this.gatherResultsBranches(d,o.url,s);h.length===0?a.push(this.getResultStem(o.id,"","",o.status,o.type,h)):a.push(this.getResultStem(o.id,o.name,n[r],o.status,o.type,h)),s.indexOf(o.id)===-1&&s.push(o.id)}else{let h=this.gatherResultsBranches(d,l,s);a.push(this.getResultStem(this.getNonResultUniqueId(),`./${u}`,u,-400,"dir",h))}}return a.sort((r,u)=>r.interrobotType.localeCompare(u.interrobotType)||r.interrobotStatus-u.interrobotStatus),a}normalizeUrl(t){try{let e=new URL(t);return`${e.origin}${e.pathname}`}catch{return t.split(/[?#]/)[0]}}async gatherResults(t){this.clearMaps();let e=(await this.getProject()).url,s=[],i=-1,a={};if(await k.execute(t,this.resultsMap,async o=>{let c=o.url;if(s.indexOf(c)>=0)return;s.push(c);let h=o.id;c===e&&(i=h),this.resultsMap.set(h,o),this.resultUrlMap.set(this.normalizeUrl(c),o)},!0,!1,"Rendering\u2026"),i===-1)return{};let n=this.resultsMap.get(i);if(n===void 0)return{};let r=[...this.resultUrlMap.keys()];r.sort();let u={__meta__:{url:this.normalizeUrl(n.url)}};for(let o of r){let c=new URL(o),h=c.origin,g=c.pathname.split("/").filter(w=>w),x=g.length,v=[],y=u;g.forEach((w,C)=>{v.push(w),x-1===C?y[w]||(y[w]={__meta__:{url:o}}):y[w]||(y[w]={__meta__:{url:`${h}/${v.join("/")}/`}}),y=y[w]})}let d=[],l=this.gatherResultsBranches(u,n.url,d);return this.renderedIds=d,a=this.getResultStem(n==null?void 0:n.id,new URL(n.url).hostname,"",n==null?void 0:n.status,n==null?void 0:n.type,l),a}fromApi(t){return e=>{let s=performance.now();this.gatherResults(t).then(i=>{e(i,s,0)}).catch(i=>{console.error("Error gathering results:",i),e({},performance.now(),0)})}}};D.meta={title:"Website Hypertree",category:"Visualization",version:"1.0.1",author:"InterroBot",synopsis:"create a hypertree from website content",description:`Get a new, uniquely hyperbolic perspective on your website\u2014your
            web hierarchy projected on a Poincar\xE9 disc. 


            Hyperbolic trees display large hierarchies more effectively than traditional
            layouts because hyperbolic space grows exponentially. Knock out this details tab
            for even more projection area, and work the wheel-zoom to navigate
            depth.
            


            InterroBot Website Hypertree utilizes the d3 and d3-hypertree open-source visualization
             libraries to bring your website to life.`};D.resultDialogId="ResultDialog";D.panicDialogId="PanicDialog";D.searchDialogId="SearchDialog";D.searchResultsDialogId="SearchDialogResults";p.initialize(D);})();
